#!/bin/sh
usage="pidswallow (pid swallow WM/DE independent)
Hides terminal window automatically, so that you don't have to

pidswallow [OPTION ...]

OPTIONS:
        -h  --help              Show this message
        -s  --swallow <CWID>    Hides parent window of the given child window id.
        -v  --vomit <CWID>      Unhides parent window of the given child window id.
        -t  --toggle <CWID>     toggle between swallow and vomit. (default)
        -g  --glue              treat if parent and child window are same. (recommended)
        -l  --loop              listen and hide / unhide window on launch / remove.
        -V  --verbose           Shows useful information.

bugs/issues: https://github.com/liupold/pidswallow.
"
swallowable=" $TERMINAL urxvt kitty alacritty konsole $PIDSWALLOW_SWALLOWABLE "
blacklist=" $swallowable $PIDSWALLOW_BLACKLIST "
# shellcheck disable=SC2016 # having "$pwid" unexpanded is intentional
swallow_command=${PIDSWALLOW_SWALLOW_COMMAND:-'xdotool windowunmap --sync "$pwid"'}
# shellcheck disable=SC2016
vomit_command=${PIDSWALLOW_VOMIT_COMMAND:-'xdotool windowmap --sync "$pwid"'}
verbose=0
glue=0

vomit() {
        # focuses parent if child is dead.
        unset cwid pwid # similar to local
        cwid="$1"
        [ -f "/tmp/swallowed-by-$cwid" ] || return 1
        pwid=$(cat "/tmp/swallowed-by-$cwid")
        eval "$vomit_command"
        xprop -id "$cwid" >/dev/null 2>&1 && xdotool windowactivate "$cwid"
        [ "$verbose" -eq 1 ] && echo "$cwid vomited $pwid"
        rm "/tmp/swallowed-by-$cwid"

        [ "$glue" -eq  0 ] && return 0

        [ -f "/tmp/swallowed-by-$cwid-desk" ] \
                && desk=$(cat /tmp/swallowed-by-"$cwid"-desk) && \
                xdotool set_desktop_for_window "$pwid" "$desk"

        [ -f "/tmp/swallowed-by-$cwid-size" ] \
                && csize=$(cat /tmp/swallowed-by-"$cwid"-size) && \
                xdotool windowsize "$pwid" "${csize%% *}" "${csize##* }"

        [ -f "/tmp/swallowed-by-$cwid-pos" ] \
                && cpos=$(cat /tmp/swallowed-by-"$cwid"-pos) && \
                xdotool windowmove "$pwid" "${cpos%% *}" "${cpos##* }"

        rm "/tmp/swallowed-by-$cwid-pos" "/tmp/swallowed-by-$cwid-size" \
                "/tmp/swallowed-by-$cwid-desk"
}


swallow() {
        # return values
        # 0 -> Found and swallowed
        # 1 -> No swallowable window found.
        # 2x -> xprop return a non zero exit code.(x is returned by xprop)
        # 3 -> window lacks a _NET_WM_PID property.
        # 4 -> window already swallowed
        unset cwid pwid cname pname ppid cpid # similar to local.
        cwid="$1"
        [ -f "/tmp/swallowed-by-$cwid" ] && return 4

        cpid="$(xprop _NET_WM_PID -id "$cwid" 2>/dev/null)" || return "2$?"
        [ "${cpid#*not found*}" != "$cpid" ] && return 3 # window didn't have _NET_WM_PID
        cpid="${cpid##* }"
        cname="$(ps -p "$cpid" -o comm=)"
        [ "${blacklist#* $cname }" != "$blacklist" ] && return 0

        family_tree="$(pstree -ATlsp "$cpid" \
                | sed -n -e 's|(|:|g' -e 's|)||g' \
                -e 's|---|\n|g' -e 's|-+-|\n|g' -e '1p' | tac)"

        [ "$verbose" -eq 1 ] && echo "$family_tree"

        for parent in $family_tree; do
                pname="${parent%%:*}" # ancestor name
                [ "${swallowable#* $pname }" != "$swallowable" ] \
                        && ppid="${parent##*:}" && break
        done
        [ -z "$ppid" ] && return 1 # nothing swallowable.
        pwid="$(xdotool search --pid "$ppid" 2>/dev/null)"
        eval "$swallow_command"
        [ "$verbose" -eq 1 ] && echo "$cname($cwid) swallowed $pname($pwid)"
        echo "$pwid" > "/tmp/swallowed-by-$cwid"
        [ "$glue" -eq  0 ] && return 0

        eval "$PIDSWALLOW_PREGLUE_HOOK"

        ppos=$(xdotool getwindowgeometry "$pwid" | \
                grep -o '[0-9]\+,[0-9]\+' | tr ',' ' ')

        psize=$(xdotool getwindowgeometry "$pwid" | \
                grep -o '[0-9]\+x[0-9]\+' | tr 'x' ' ')

        xdotool windowsize "$cwid" "${psize%% *}" "${psize##* }"
        xdotool windowmove "$cwid" "${ppos%% *}" "${ppos##* }"

        { xprop -spy -id "$cwid" | while read -r _; do
                [ ! -f "/tmp/swallowed-by-$cwid" ] && exit
                cgeo="$(xdotool getwindowgeometry "$cwid")"

                cpos=$(echo "$cgeo" | \
                        grep -o '[0-9]\+,[0-9]\+' | tr ',' ' ')
                csize=$(echo "$cgeo" | \
                        grep -o '[0-9]\+x[0-9]\+' | tr 'x' ' ')
                desk="$(xdotool get_desktop_for_window "$cwid")"

                [ -n "$csize" ] && echo "$cpos" > "/tmp/swallowed-by-$cwid-pos"
                [ -n "$cpos" ] && echo "$csize" > "/tmp/swallowed-by-$cwid-size"
                [ -n "$desk" ] && echo "$desk" > "/tmp/swallowed-by-$cwid-desk"
        done } 2>/dev/null &
}

toggle() {
        cwid="$1"
        if [ -f "/tmp/swallowed-by-$cwid" ]; then
                vomit "$cwid"
                return "$?"
        else
                swallow "$cwid"
                return "$?"
        fi
}

loop() {
        prev_event="$(xprop -root  _NET_CLIENT_LIST)"

        xprop -spy -root  _NET_CLIENT_LIST | while read -r event; do
                unset node_added node_removed

                for wid in $(echo "${event##*# }" | tr -d ','); do
                        [ "${prev_event#*$wid}" = "$prev_event" ] \
                                && node_added="$wid" && break
                done


                for wid in $(echo "${prev_event##*# }" | tr -d ','); do
                        [ "${event#*$wid}" = "$event" ] \
                                && node_removed="$wid" && break
                done

                prev_event="$event"
                # [ -z "${node_added}${node_removed}" ] && continue
                [ -n "$node_added" ] && swallow "$node_added"
                [ -n "$node_removed" ] && vomit "$node_removed"
        done
        return 1
}

[ -p /dev/stdin ] && eval set -- "$* $(cat /dev/stdin)" # basic pipe support
[ "$#" -eq 0 ] && echo "$usage" && exit 1

TEMP=$(getopt -o 'Vghlt:s:v:' --long 'verbose,glue,help,loop,toggle:,swallow:,vomit:' \
        -n 'pidswallow' -- "$@")
eval set -- "${TEMP}"; unset TEMP

while true; do
        case "$1" in
                '-h' | '--help' )
                        echo "$usage" && exit 0;;
                '-V'|'--verbose')
                        verbose=1
                        shift; continue;;
                '-g'|'--glue')
                        glue=1
                        shift; continue;;
                '-t'|'--toggle')
                        toggle "$2" || exit "$?"
                        shift 2; continue;;
                '-s'|'--swallow')
                        swallow "$2" || exit "$?"
                        shift 2; continue;;
                '-v'|'--vomit')
                        vomit "$2" || exit "$?"
                        shift 2; continue;;
                '-l'|'--loop')
                        loop || exit "$?"
                        shift; continue;;
                '--')
                        shift; break;;
                *)
                        echo "Internal error!" >&2
                        echo "$usage" && exit 1;;
        esac
done

# toggle WID on first non-flag argument
[ -n "$*" ] && toggle "$1" && shift

# error if there's more than one non-flag argument
if [ -n "$*" ]; then
        echo "Unrecognized trailing option '$*'" >&2
        exit 1
fi
